---
title: "ChronochRt: Data and plot structure"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{ChronochRt}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

#library(ChronochRt)
library(knitr)
devtools::load_all()
```

To execute the examples shown in this vignette, load the package:  

```{r setup, eval=FALSE}
library(ChronochRt)
```

## The data set 
Chronological data are stored in a table. Each row represents a _chron_ (a chronological unit of any kind). The columns store the information of these chrons. The basic information of a _chron_ is:  

* Which `region` is the _chron_ defined for? (This must not necessarily be a geographical region but can also be e.g. a reference or any other kind of overarching category)
* What is its `name`? 
* When does it `start`? 
* When does it `end`?
* What is its `level` within the chronological system to be plotted?
* The parameter `add`. 

The parameter `add` is required for plotting the chart. ChronochRt offers the option to plot an `add`itional chronological column for each region to include e.g. long and short chronologies of regions, or competing chronological systems. Setting the variable `add` of a _chron_ to `TRUE` signals ChronochRt to plot this _chron_ in the additional column of the same region.  

These six variables are essential for the package and therefore cannot be renamed. When you import or convert a data set, you will have to indicate their corresponding columns in the data set. It is possible to store additional variables in the chrons, such as information to change e.g. the position and angle of the _chron_'s names or additional information, useful for further work with the data set.

### BCE and AD
Years BCE are indicated by negative `start` and `end` dates, e.g. `-100` corresponds to 100 BCE and 100 to 100 A.D., respectivly. The package can handle the year 0.  

### Important note  
In ChronochRt, each _chron_ is independently evaluated. Consequently, all parameters listed above need to be stored for every single _chron_. It is indispensable that start and end date are identical to the preceeding and subsequent _chron_ as well as subchrons starting or ending in the same year. Whilst it seens tedious, this feature allows the package to plot interruptions and hiatus in the chronological sequence, like the abandonment of settlements or entire regions (see example below). At the same time it simplifies the structure of the chronological data, as each _chron_ stands for itself.   

## The chronological chart

This example highlights the structure of a chronological dataset, called `chrons`, with a x-axis included for educational reasons: 

```{r plot_structure_data, echo=TRUE, fig.align='center', fig.width=10, message=FALSE, out.width="100%"}
chrons <- add_chron(
  region = c("region = A", "region = A", "region = A", "region = A", "region = A", "region = A", "region = A", "region = A", "region = A", "region = A", "region = A", "region = A", "region = B", "region = B", "region = B"),
  name = c("level = 1\nadd =\nFALSE", "level = 2\nadd =\nFALSE", "level = 3\nadd =\nFALSE", "level = 4\nadd =\nFALSE", "level = 5\nadd =\nFALSE","level = 1\nadd =\nTRUE","level = 2\nadd =\nTRUE","level = 2\nadd =\nTRUE", "add =\nTRUE", "level = 3", "add = TRUE", "level = 4", "level = 1\nadd = FALSE", "level = 2\nadd = FALSE", "level = 3\nadd = FALSE"),  
  start = c(-500, -500, -500, -500, -500, -400, -400, 0, 0, 200, 200, "300/300", -500, -500, -500), 
  end = c(500, 500, 500, 500, 500, 400, -50, 400, 200, 400, "300/300", 400, 500, 500, 500), 
  level = c(1, 2, 3, 4, 5, 1, 2, 2, 3, 3, 4, 4, 1, 2, 3), 
  add = c(FALSE, FALSE, FALSE, FALSE, FALSE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE, FALSE, FALSE, FALSE), 
  new_table = TRUE) 

# How does it look like? 
print(chrons)

```

```{r plot_structure_plot, echo=FALSE, fig.align='center', fig.width=10, message=FALSE, out.width="100%"}

plot_chronochrt(chrons, font_size_chrons = 4, line_break = 20) + 
  ggplot2::scale_x_continuous(name = NULL, breaks = seq(0, 2, 0.1), minor_breaks = NULL, expand = c(0,0)) 

```

Admittedly, the `name`s of the _chrons_ are not pretty but they are intended to show that the information of each _chron_ is directly mirrored in the plot and can reconstructed from it.  

### How does it work? 
Each region is plotted independently. Within a region, all _chrons_ with `add = FALSE` will be evenly scaled according to the maximum `level`, e.g. in region A in the `add = FALSE`-column the maximum `level` is 5, hence, all _chrons_ will be 1/5 wide. Similarly in region B, the maximum `level`is 3, consequently all _chrons_ are 1/3 wide. This essentially transform the x-axis into percentages, allowing to easily add additional labels or customise the position and angle of the _chrons'_ names. Likewise, all _chrons_ in the `add = TRUE`-cloumn are displayed with their x-value shifted by 1, i.e. they are plotted between 1 and 2.  
If not all _chrons_ are further subdivided, empty space is filled by the rightmost _chrons_. However, by default the names of _chrons_ from the same level will be placed on the same x-value. In complex charts this increases readability and ensures appropriate space for addtional labels, even if it can produce odd looking empty space in small plots (see above). 

### Unclear `start` and `end` dates
The dashed horizontal line between two _chrons_ appears when the respective `start` and/or `end` date of a _chron_ are coded as `"300/300"`, indicating that they canot be stated precisely. The reasons for unclear or vague transitions are manifold: the transition between two chronological units or strata are blurred, sites within a region yield different dates for the same transition, transitions are not always clearly expressed in the material record, or it is debated whether this transition exists, just to name a few.  
ChronochRt will automatically draw dates given in the format `"year1/year2"` as dashed instead of solid lines. To indicate a transition period, its `start` and `end` date is given, e.g. `"50/100"`. For a disctinct date, the two years are the same.  
Does the order of the dates matter? Lets see what happens when we play with it a bit, using a different `region` for each kind of combination (we use `arrange_regions()` to modify the default alphabetical order of the regions in the plot): 

```{r unclear, echo=TRUE, fig.align='center', fig.width=10, message=FALSE, out.width="100%"}

data <- add_chron(region = "earlier/later", 
          name = c("1", "2", "1a", "1b"), 
          start = c(-100, "50/100", -100, 0), 
          end = c("50/100", 200, 0, "50/100"), 
          level = c(1, 1, 2, 2),
          add = FALSE,
          new_table = TRUE) %>%
  add_chron(region = "later/earlier", 
          name = c("1", "2", "1a", "1b"), 
          start = c(-100, "100/50", -100, 0), 
          end = c("100/50", 200, 0, "100/50"), 
          level = c(1, 1, 2, 2),
          add = FALSE,
          new_table = FALSE) %>%
  add_chron(region = "mixed", 
          name = c("1", "2", "1a", "1b"), 
          start = c(-100, "50/100", -100, 0), 
          end = c("50/100", 200, 0, "100/50"), 
          level = c(1, 1, 2, 2),
          add = FALSE,
          new_table = FALSE) %>%
    add_chron(region = "same", 
          name = c("1", "2", "1a", "1b"), 
          start = c(-100, "100/100", -100, 0), 
          end = c("100/100", 200, 0, "100/100"), 
          level = c(1, 1, 2, 2),
          add = FALSE,
          new_table = FALSE) %>%
  arrange_regions(order = c("earlier/later", "later/earlier", "same", "mixed"))

plot_chronochrt(data)

```


Indeed, the order matters. In the first two columns we see that vertical lines will always be drawn until the date given before the "/", also the position of the _chron's_ name is calculated according to this date. And from the last column we see that we have to be consistent with the order to get a correct chronological chart. 

## Custom labels 
Custom labels are optional and hence are stored in an independent data set. Custom text can be placed anywhere on the chronological chart to indicate e.g. special events. As indicated before, it is assumed that they will predominantly appear on the right side of a chronological column, therefore they are always right-aligned.  

Custom labels are recorded with the function `add_label_text()`. It needs to be specified in which `region` it should be plotted, the `year` it should be placed, its `position` on the x-axis and the `label`'s text. As the axis scaled from 0 to 1, the value needs to be between 0 and 1 (or 2 if both columns are used):   

```{r label, echo=TRUE, fig.align='center', fig.width=10, message=FALSE, out.width="100%"}

data_label <- add_label_text(region = "earlier/later", 
                             year = 50, 
                             position = 0.95, 
                             label = "This date in front of the /.", 
                             new = TRUE)

data_label <- add_label_text(data = data_label, 
                             region = "later/earlier", 
                             year = 100, 
                             position = 0.9, 
                             label = "This date in\nfront of the /.", 
                             new = FALSE) %>%
  add_label_text(region = "mixed", 
                 year = 75, 
                 position = 0.48, 
                 label = "Both dates are\nin fromt of the /.", 
                 new = FALSE)

data_label <- add_label_text(data = data_label, 
                             region = "same", 
                             year = c(125, 175), 
                             position = 0.9, 
                             label = "same", new = FALSE)

plot_chronochrt(data, labels_text = data_label)
```

## Compatibility with the [tidyverse](https://www.tidyverse.org/), incl. [ggplot2](https://ggplot2.tidyverse.org/)

ChronochRt builds upon the tidyverse environment. Hence its functions can be seamlessly integrated into e.g. pipes (as seen in some examples, look for the [pipe operator `%>%`](https://style.tidyverse.org/pipes.html)). Likewise, `plot_chronochrt()` returns a ggplot2-object, which can be easily enhanced afterwards by e.g. more complex designs using the `+` operator. As an example, the first plot in this vignette was created with the following code to display the usually omitted x-axis: 
```{r , eval=FALSE}

plot_chronochrt(chrons, font_size_chrons = 4, line_break = 20) + 
  scale_x_continuous(name = NULL, breaks = seq(0, 2, 0.1), minor_breaks = NULL, expand = c(0,0))

```

## Some explanation to the example code
The examples shown in this vignette contain some "tricks", which might facilitate the usage of ChronochRt. They are not features of ChronochRt but of R and the packages ChronochRt builds upon (see above). 

* Text wrapping in labels and names of _chrons_ can be easily implemented by typing `"\n"`instead of a space where the text should be wrapped (spaces at the end of lines will result in unclean text alignment). The chronological data is imported from an Excel file, text wrapping can be implemented in Excel by inserting line breaks with the combination `Alt + Return` (Windows) and `Control + Command + Enter` or `Control + Option + Enter` (Mac). 
* If a value in a column is identical for all rows, it is sufficient to type it in once. It is not necessary to type it for every row (see the code to add the labels "same" in the last example). This facilitates not only coding but also ensures that e.g. the position or text of labels are identical and not erroneous because of typos. 
